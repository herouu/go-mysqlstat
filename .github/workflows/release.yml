name: Go Release Binaries Release

on:
  push:
    branches: [ master ]

permissions:
  contents: write
  packages: write

jobs:
  load-env:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.load-value.outputs.version }}
      name: ${{ steps.load-value.outputs.name }}
      description: ${{ steps.load-value.outputs.description }}
      maintainer: ${{ steps.load-value.outputs.maintainer }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v2
      - name: Install yq
        run: |
          sudo snap install yq
      - name: Extract Value from YAML
        id: load-value
        run: |
          version=$(yq '.app.version' version.yml )
          name=$(yq '.app.name' version.yml )
          description=$(yq '.app.description' version.yml )
          maintainer=$(yq '.app.maintainer' version.yml )
          # å¼€å‘ç‰ˆæœ¬
          dev_version=$(echo $version)
          echo "The extracted value is: $dev_version, $name, $description, $maintainer"
          echo "::set-output name=version::$dev_version"
          echo "::set-output name=name::$name"
          echo "::set-output name=description::$description"
          echo "::set-output name=maintainer::$maintainer"
  
  

  check_and_create_release:
    runs-on: ubuntu-latest
    needs: load-env
    outputs:
      branch_or_tag: ${{ steps.check_release.outputs.branch_or_tag }}
    env:
      VERSION: ${{ needs.load-env.outputs.version }}
      APP_NAME: ${{ needs.load-env.outputs.name }}
      DESC: ${{ needs.load-env.outputs.description }}
      MAINTAINER: ${{ needs.load-env.outputs.maintainer }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v2

      - name: Check if Tag Exists
        id: check_tag
        uses: actions/github-script@v7
        env:
          tag: v${{ env.VERSION }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          # åˆ¤æ–­tagæ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨åˆ™åˆ é™¤ï¼Œæ–°å»ºtag
          script: |
            const ref = 'tags/${{env.tag}}'
            const endsWith = '${{env.tag}}'
            
            
            const releases = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            
            // åˆ é™¤release                                   
            const release = releases.data.forEach(r => {
              if (r.tag_name.includes(endsWith)) {
                console.log("releaseå­˜åœ¨,åˆ é™¤release",r.tag_name)
                github.rest.repos.deleteRelease({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  release_id: r.id
                });
              }
            });
            
            const tags = await github.rest.git.listMatchingRefs({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: 'tags'
            });
            
            // åˆ é™¤tags 
            const filteredTags = tags.data.forEach(tag => {
              if (tag.ref.includes(endsWith)) {
                tagStr = tag.ref.replace('refs/','')
                console.log("tagå­˜åœ¨,åˆ é™¤tag",tagStr)
                github.rest.git.deleteRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: tagStr
                });
              }
            });
            
            console.log("tagä¸å­˜åœ¨,æ–°å»ºtag",ref)
            await github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: "refs/"+ref,
              sha: context.sha });

      - name: Check if Release Exists
        id: check_release
        uses: actions/github-script@v7
        env:
          tag: v${{ env.VERSION }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const releases = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            const release = releases.data.find(r => r.tag_name === "${{env.tag}}");
            if (release) {
                console.log(release);
                await github.rest.repos.deleteRelease({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    release_id: release.id
                });
              core.setOutput('exists', false);
              core.setOutput('branch_or_tag', release.tag_name);
            } else {
              console.log('Release not found');
              core.setOutput('exists', false);
              core.setOutput('branch_or_tag', "${{env.tag}}");
            }

      - name: Build Changelog
        uses: mikepenz/release-changelog-builder-action@v4
        id: changelog
        with:
          configurationJson: |
            {
              "template": "#{{CHANGELOG}}\n\n<details>\n<summary>Uncategorized</summary>\n\n#{{UNCATEGORIZED}}\n</details>",
              "categories": [
                {
                    "title": "## ğŸ’¬ Other",
                    "labels": ["other"]
                },
                {
                    "title": "## ğŸ“¦ Dependencies",
                    "labels": ["dependencies"]
                }
              ]
            }
          outputFile: CHANGELOG.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


      - name: Create Release If Not Exists
        if: ${{ steps.check_release.outputs.exists == 'false' }}
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.check_release.outputs.branch_or_tag }}
          release_name: Release ${{ steps.check_release.outputs.branch_or_tag }}
          body: ${{ steps.changelog.outputs.changelog }}
          draft: false
          prerelease: false

  build-go-binary:
    needs: [ check_and_create_release,load-env ]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        goos: [ linux, windows ] # éœ€è¦æ‰“åŒ…çš„ç³»ç»Ÿ
        goarch: [ amd64, arm64 ]
        exclude:
          - goarch: arm64
            goos: windows
          - goarch: arm64
            goos: linux
    steps:
      - uses: actions/checkout@v4
      - uses: wangyoucao577/go-release-action@v1.50
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }} # ä¸€ä¸ªé»˜è®¤çš„å˜é‡ï¼Œç”¨æ¥å®ç°å¾€ Release ä¸­æ·»åŠ æ–‡ä»¶
          goos: ${{ matrix.goos }}
          goarch: ${{ matrix.goarch }}
          release_tag: ${{needs.check_and_create_release.outputs.branch_or_tag}}
          overwrite: true
          goversion: 1.22 # å¯ä»¥æŒ‡å®šç¼–è¯‘ä½¿ç”¨çš„ Golang ç‰ˆæœ¬
          binary_name: ${{needs.load-env.outputs.name}}
          compress_assets: auto

  build-linux-packages:
    runs-on: ubuntu-latest
    needs:
      - build-go-binary
      - load-env
    env:
      VERSION: ${{ needs.load-env.outputs.version }}
      APP_NAME: ${{ needs.load-env.outputs.name }}
      DESC: ${{ needs.load-env.outputs.description }}
      MAINTAINER: ${{ needs.load-env.outputs.maintainer }}
    steps:
      - uses: actions/checkout@v4
      - name: print env
        env:
          MY_GITHUB_REF: ${{ github.ref }}
        run: |
          echo "APP_NAME=${APP_NAME}"
          echo "version=${MY_GITHUB_REF}"
          BRANCH_NAME=${MY_GITHUB_REF#refs/heads/}
          if [[ "$BRANCH_NAME" == "$MY_GITHUB_REF" ]]; then
          echo "Error: The reference does not seem to be a branch."
          else
          echo "The branch name is: $BRANCH_NAME"
          fi
          TAG_NAME=${MY_GITHUB_REF#refs/tags/}
          if [[ "$TAG_NAME" == "$MY_GITHUB_REF" ]]; then
          echo "Error: The reference does not seem to be a tag."
          else
          echo "The tag name is: $TAG_NAME"
          fi

      - uses: jiro4989/build-deb-action@v3
        with:
          package: ${{ env.APP_NAME }}
          package_root: .
          maintainer: ${{ env.MAINTAINER }}
          version: ${{ env.VERSION }}
          arch: 'amd64'
          desc: '${{ env.DESC }}'

      - uses: jiro4989/build-rpm-action@v2
        with:
          summary: '${{ env.DESC }}'
          package: ${{ env.APP_NAME }}
          package_root: .
          maintainer: ${{ env.MAINTAINER }}
          version: ${{ env.VERSION }}
          arch: 'x86_64'
          desc: '${{ env.DESC }}'


      - uses: actions/upload-artifact@v4
        with:
          name: artifact-deb
          path: |
            ./*.deb

      - uses: actions/upload-artifact@v4
        with:
          name: artifact-rpm
          path: |
            ./*.rpm
  
  

  upload-linux-packages:
    runs-on: ubuntu-latest
    needs:
      - build-linux-packages
      - check_and_create_release
    strategy:
      matrix:
        include:
          - pkg: deb
            asset_content_type: application/vnd.debian.binary-package
          - pkg: rpm
            asset_content_type: application/x-rpm
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: artifact-${{ matrix.pkg }}

      - id: vars
        run: |
          echo "::set-output name=asset_name::$(ls *.${{ matrix.pkg }} | head -n 1)"

      - name: Upload Assets
        uses: softprops/action-gh-release@v1
        with:
          # æŒ‡å®šä½ æƒ³è¦è¿½åŠ èµ„äº§çš„Releaseçš„tag
          tag_name: ${{needs.check_and_create_release.outputs.branch_or_tag}}
          # ä¸Šä¼ çš„æ–‡ä»¶åˆ—è¡¨ï¼Œå¯ä»¥ä½¿ç”¨é€šé…ç¬¦
          files: |
            ${{ steps.vars.outputs.asset_name }}
          # è®¾ç½®ä¸ºtrueï¼Œå…è®¸è¦†ç›–åŒåæ–‡ä»¶
          append_body: true
          # å¦‚æœä¸å¸Œæœ›è‡ªåŠ¨åˆ›å»ºReleaseï¼Œåˆ™è®¾ç½®æ­¤å‚æ•°
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ä¸Šä¼ DEBå’ŒRPMåŒ…åˆ°GemFury
      - name: Upload to GemFury
        env:
          GEMFURY_API_KEY: ${{ secrets.GEMFURY_API_KEY }}
        run: |
          curl -F package=@"${{ steps.vars.outputs.asset_name }}" https://{$GEMFURY_API_KEY}@push.fury.io/herouu/         
